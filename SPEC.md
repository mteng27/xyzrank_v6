# XYZRank 项目需求文档

## 1. 项目概述

### 1.1 项目名称
XYZRank - 小宇宙播客排名追踪系统

### 1.2 项目目标
构建一个自动化播客数据追踪和排名系统，用于：
- 管理小宇宙平台上的播客信息
- 每日自动抓取播客订阅者数量等关键指标
- 记录历史数据变化趋势
- 提供数据查询和分析 API

### 1.3 核心价值
- **数据追踪**：持续监控播客订阅者数量变化
- **历史分析**：保存每日快照，支持趋势分析
- **自动化**：定时任务自动抓取，减少人工干预
- **数据导入**：支持批量导入播客数据

## 2. 功能需求

### 2.1 播客管理

#### 2.1.1 播客信息管理
- **创建播客**：支持手动添加播客信息
  - 必填字段：小宇宙ID (xyz_id)、播客名称
  - 可选字段：RSS URL、封面图、分类、描述
- **查询播客**：支持列表查询和详情查询
  - 支持分页
  - 支持按分类筛选
- **更新播客**：支持更新播客信息
- **删除播客**：支持删除播客（级联删除相关指标数据）

#### 2.1.2 数据导入
- **Excel 导入**：支持从 Excel 文件批量导入播客数据
  - 支持 .xlsx 和 .xls 格式
  - 自动识别常见列名（支持中英文）
  - 支持跳过已存在的播客或更新现有播客
  - 提供导入结果统计（成功、跳过、失败数量）

### 2.2 指标追踪

#### 2.2.1 每日指标记录
- **订阅者数量**：记录每日订阅者数量快照
- **唯一性约束**：每个播客每天只能有一条记录
- **历史查询**：支持查询指定时间范围内的指标数据
- **趋势分析**：通过历史数据支持增长趋势分析

#### 2.2.2 指标数据管理
- **手动添加**：支持手动添加每日指标
- **自动抓取**：通过爬虫自动获取最新指标
- **数据验证**：确保数据完整性和准确性

### 2.3 数据抓取

#### 2.3.1 爬虫功能
- **播客信息抓取**：从小宇宙平台抓取播客基本信息
  - 播客名称
  - RSS 链接
  - 封面图片
  - 分类信息
  - 描述信息
- **订阅者数量抓取**：抓取当前订阅者数量
  - 需要根据实际 API 或页面结构实现
  - 支持失败重试机制

#### 2.3.2 抓取任务管理
- **单播客抓取**：支持手动触发单个播客的数据抓取
- **批量抓取**：支持一次性抓取所有播客的数据
- **抓取记录**：记录每次抓取任务的执行情况
  - 开始时间、完成时间
  - 执行状态（运行中、已完成、失败）
  - 成功/失败统计
  - 错误信息

### 2.4 定时任务

#### 2.4.1 自动抓取任务
- **执行频率**：每天凌晨 2:00 自动执行
- **任务内容**：
  - 更新所有播客的基本信息
  - 抓取所有播客的订阅者数量
  - 记录每日指标快照
- **任务监控**：记录每次任务的执行结果

## 3. 技术需求

### 3.1 技术栈
- **Web 框架**：FastAPI
- **数据库**：MySQL（异步）
- **ORM**：SQLAlchemy 2.0（异步）
- **数据迁移**：Alembic
- **HTTP 客户端**：httpx
- **HTML 解析**：BeautifulSoup4
- **浏览器自动化**：Playwright（可选，用于复杂页面）
- **任务调度**：APScheduler
- **缓存**：Redis（可选）
- **数据处理**：Pandas、OpenPyXL

### 3.2 数据模型

#### 3.2.1 Podcast（播客表）
- `id`: 主键
- `xyz_id`: 小宇宙ID（唯一）
- `name`: 播客名称
- `rss_url`: RSS 链接
- `cover_url`: 封面图URL
- `category`: 分类
- `description`: 描述
- `created_at`: 创建时间
- `updated_at`: 更新时间

#### 3.2.2 PodcastDailyMetric（每日指标表）
- `id`: 主键
- `podcast_id`: 播客ID（外键）
- `snapshot_date`: 快照日期
- `subscriber_count`: 订阅者数量
- `created_at`: 创建时间
- 唯一约束：`(podcast_id, snapshot_date)`

#### 3.2.3 ScrapeRun（抓取任务记录表）
- `id`: 主键
- `started_at`: 开始时间
- `completed_at`: 完成时间
- `status`: 状态（running/completed/failed）
- `total_podcasts`: 总播客数
- `successful_count`: 成功数量
- `failed_count`: 失败数量
- `error_message`: 错误信息

### 3.3 API 设计

#### 3.3.1 播客管理 API
- `GET /api/podcasts/` - 获取播客列表
- `GET /api/podcasts/{id}` - 获取播客详情
- `POST /api/podcasts/` - 创建播客
- `PATCH /api/podcasts/{id}` - 更新播客
- `DELETE /api/podcasts/{id}` - 删除播客
- `GET /api/podcasts/{id}/metrics` - 获取播客指标
- `POST /api/podcasts/{id}/metrics` - 添加指标

#### 3.3.2 数据导入 API
- `POST /api/imports/excel` - 导入 Excel 文件

#### 3.3.3 爬虫 API
- `POST /api/scraper/run` - 执行批量抓取
- `POST /api/scraper/podcast/{id}` - 抓取单个播客
- `GET /api/scraper/runs` - 获取抓取历史

#### 3.3.4 系统 API
- `GET /health` - 健康检查
- `GET /` - 服务元信息

## 4. 非功能需求

### 4.1 性能要求
- API 响应时间 < 500ms（正常查询）
- 支持并发请求
- 数据库连接池管理

### 4.2 可靠性要求
- 数据库连接自动重试
- 抓取任务失败不影响系统运行
- 错误日志记录

### 4.3 可维护性要求
- 代码结构清晰，模块化设计
- 完善的日志记录
- 数据库迁移管理

### 4.4 安全性要求
- 数据库连接信息通过环境变量配置
- API 输入验证
- SQL 注入防护（使用 ORM）

## 5. 开发计划

### 5.1 第一阶段：基础功能（已完成）
- ✅ 数据库模型设计
- ✅ 基础 API 框架
- ✅ CRUD 操作
- ✅ 数据导入功能
- ✅ 爬虫服务框架
- ✅ 定时任务框架

### 5.2 第二阶段：完善功能
- ⏳ 完善爬虫实现（根据实际 API 调整）
- ⏳ 添加错误处理和重试机制
- ⏳ 性能优化
- ⏳ 添加单元测试

### 5.3 第三阶段：扩展功能
- ⏳ 数据分析和统计 API
- ⏳ 排名计算功能
- ⏳ 数据可视化接口
- ⏳ 前端界面（可选）

## 6. 使用场景

### 6.1 初始数据导入
1. 准备包含播客信息的 Excel 文件
2. 通过 API 上传文件导入数据
3. 系统自动解析并创建播客记录

### 6.2 日常数据追踪
1. 系统每天凌晨自动抓取所有播客数据
2. 记录每日订阅者数量快照
3. 管理员可通过 API 查询历史数据

### 6.3 手动数据更新
1. 发现某个播客信息需要更新
2. 通过 API 手动触发该播客的数据抓取
3. 系统更新播客信息和最新指标

### 6.4 数据分析
1. 查询指定播客的历史指标数据
2. 分析订阅者数量变化趋势
3. 生成排名和统计报告

## 7. 注意事项

### 7.1 爬虫实现
- 需要根据小宇宙平台的实际 API 或页面结构实现
- 注意遵守网站的 robots.txt 和使用条款
- 建议添加请求频率限制，避免被封禁
- 考虑使用代理或分布式抓取（如需要）

### 7.2 数据准确性
- 订阅者数量抓取可能需要登录或 API Key
- 需要验证抓取数据的准确性
- 建议添加数据校验机制

### 7.3 扩展性
- 当前设计支持添加更多指标类型
- 可以扩展支持其他播客平台
- 可以添加更多分析功能

## 8. 项目文件结构

```
xyzrank_v6/
├── backend/
│   ├── app/
│   │   ├── api/              # API 路由
│   │   │   ├── podcasts.py  # 播客管理 API
│   │   │   ├── imports.py   # 数据导入 API
│   │   │   └── scraper.py   # 爬虫 API
│   │   ├── core/            # 核心配置
│   │   │   └── config.py    # 应用配置
│   │   ├── db/              # 数据库
│   │   │   └── session.py   # 数据库会话
│   │   ├── models/          # 数据模型
│   │   │   └── podcast.py   # 播客相关模型
│   │   ├── services/        # 业务逻辑服务
│   │   │   ├── import_service.py  # 数据导入服务
│   │   │   └── scraper_service.py # 爬虫服务
│   │   ├── tasks/           # 定时任务
│   │   │   └── scheduler.py # 任务调度器
│   │   └── main.py          # 应用入口
│   ├── migrations/          # 数据库迁移
│   └── requirements.txt     # 依赖列表
├── SPEC.md                  # 本需求文档
└── README.md               # 项目说明文档
```

## 9. 更新日志

- **2024-12-XX**: 初始需求文档创建
- 项目基础架构搭建完成
- 核心功能模块实现完成

